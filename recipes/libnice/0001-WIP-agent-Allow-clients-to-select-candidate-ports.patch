From 1643633a42342f15b145f5af5f5c397b82c98930 Mon Sep 17 00:00:00 2001
From: Arun Raghavan <git@arunraghavan.net>
Date: Tue, 13 Oct 2015 09:30:48 +0530
Subject: [PATCH] WIP agent: Allow clients to select candidate ports

---
 agent/agent.c | 42 +++++++++++++++++++++++++++++++++++++++---
 1 file changed, 39 insertions(+), 3 deletions(-)

diff --git a/agent/agent.c b/agent/agent.c
index 259fdc9..528b2ab 100644
--- a/agent/agent.c
+++ b/agent/agent.c
@@ -127,6 +127,7 @@ enum
   SIGNAL_NEW_SELECTED_PAIR_FULL,
   SIGNAL_NEW_CANDIDATE_FULL,
   SIGNAL_NEW_REMOTE_CANDIDATE_FULL,
+  SIGNAL_SELECT_LOCAL_PORT,
 
   N_SIGNALS,
 };
@@ -999,6 +1000,33 @@ nice_agent_class_init (NiceAgentClass *klass)
           NICE_TYPE_CANDIDATE,
           G_TYPE_INVALID);
 
+  /**
+   * NiceAgent::select-local-port
+   * @agent: The #NiceAgent object
+   * @stream_id: The stream under consideration
+   * @component_id The component under consideration
+   *
+   * Used to select the local port to use for the given stream/component pair.
+   * Signal handlers may return 0 to revert to the default (randomly selected
+   * port in specified range).
+   *
+   * Since: XXX
+   */
+  signals[SIGNAL_SELECT_LOCAL_PORT] =
+      g_signal_new (
+          "select-local-port",
+          G_OBJECT_CLASS_TYPE (klass),
+          G_SIGNAL_RUN_LAST,
+          0,
+          NULL,
+          NULL,
+          NULL,
+          G_TYPE_UINT,
+          2,
+          G_TYPE_UINT,
+          G_TYPE_UINT,
+          G_TYPE_INVALID);
+
   /* Init debug options depending on env variables */
   nice_debug_init ();
 }
@@ -2733,10 +2761,18 @@ nice_agent_gather_candidates (
             break;
         }
 
-        start_port = component->min_port;
-        if(component->min_port != 0) {
-          start_port = nice_rng_generate_int(agent->rng, component->min_port, component->max_port+1);
+        start_port = 0;
+        g_signal_emit (agent, signals[SIGNAL_SELECT_LOCAL_PORT], NULL, stream_id,
+            cid, &start_port);
+        /* XXX: check min/max, do we need to worry about threading? */
+
+        if (!start_port) {
+          start_port = component->min_port;
+          if(component->min_port != 0) {
+            start_port = nice_rng_generate_int(agent->rng, component->min_port, component->max_port+1);
+          }
         }
+
         current_port = start_port;
 
         host_candidate = NULL;
-- 
2.4.3

